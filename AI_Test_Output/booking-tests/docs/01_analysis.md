**Service**

| Function | Nhiệm vụ chính | Tham số (kiểu) | Giá trị trả | Quy tắc nghiệp vụ chính | Edge cases (≥3) | Cần mock |
|---|---|---|---|---|---|---|
| IOrderService.bookOneBike | Tạo đơn thuê PENDING cho 1 xe | customerId (int), bikeId (int), start (java.sql.Date), end (java.sql.Date) | orderId (int) | - start/end bắt buộc, start ≤ end. - Xe phải "bookable" (tồn tại, không bảo dưỡng). - Không được trùng lịch với đơn CONFIRMED khác (overlap đóng). - Tính giá theo pricePerDay tại thời điểm đặt; ghi nhận đơn và chi tiết đơn trong 1 transaction. | - start=null hoặc end=null. - start > end; start=end (đặt 1 ngày). - bikeId không tồn tại hoặc không "bookable". - Có đơn CONFIRMED giao nhau với [start,end]. - customerId không map được Customer. | - Mock IOrderDao.getBikePriceIfBookable, isOverlappingLocked, createPendingOrder. - Không chạm DB/Connection. - Khi dùng trong Servlet: mock chính IOrderService để ném lỗi/thành công. |
| IOrderService.isBikeAvailable | Kiểm tra xe rảnh trong [start,end] | bikeId (int), start (java.sql.Date), end (java.sql.Date) | boolean | - Chỉ xét đơn status='confirmed'. - Overlap theo NOT (end_date < start OR start_date > end) tức giao nhau theo khoảng đóng. | - start/end null hoặc start > end. - Đặt biên cùng ngày (ví dụ end == start). - bikeId không tồn tại. | - Mock tầng truy vấn (DAO/DBConnection) hoặc mock trực tiếp IOrderService trả true/false theo kịch bản. |
| IOrderService.getOverlappingRanges | Trả về các khoảng đơn CONFIRMED giao với [start,end] | bikeId (int), start (java.sql.Date), end (java.sql.Date) | List<OverlappedRange> | - Chỉ lấy đơn 'confirmed'. - Điều kiện giao nhau giống isBikeAvailable. - Sắp xếp theo start_date. | - Không có bản ghi: trả list rỗng. - start/end null hoặc đảo ngược. - bikeId không tồn tại. | - Mock DAO trả về các OverlappedRange mẫu; không gọi DB thật. |
| IMotorbikeService.findAll | Lấy tất cả xe | — | List<Motorbike> | - Trả tất cả xe hợp lệ. - Có thể áp dụng filter mặc định ở DAO (nếu có). | - DAO trả rỗng. - Lỗi truy xuất. - Dữ liệu có xe không khả dụng/ẩn. | - Mock IMotorbikeDao.findAll. |
| IMotorbikeService.findByTypeId | Lấy xe theo typeId | typeId (int) | List<Motorbike> | - Chỉ trả xe thuộc typeId. | - typeId không tồn tại → rỗng. - typeId âm. - Dữ liệu xe ở trạng thái không khả dụng. | - Mock IMotorbikeDao.findByTypeId. |
| IMotorbikeService.search | Tìm kiếm + phân trang + sort | typeId (Integer), startDate/endDate (java.sql.Date), maxPrice (BigDecimal), keyword (String), sort (String), page (int), size (int) | List<MotorbikeListItem> | - Filter theo tham số nếu có (null = bỏ qua). - Nếu có ngày, chỉ trả xe rảnh giai đoạn đó (do DAO xử lý). - Sort theo whitelist; fallback khi sort không hợp lệ. - Phân trang an toàn (page, size ≥ 0; giới hạn size). | - startDate > endDate; startDate=endDate. - sort không hợp lệ/tiêm nhiễm. - page < 0 hoặc size ≤ 0/quá lớn. - keyword null/blank. | - Mock IMotorbikeDao.search trả danh sách theo kịch bản; không chạm DB. |
| IMotorbikeService.count | Đếm kết quả tìm kiếm | typeId (Integer), startDate/endDate (java.sql.Date), maxPrice (BigDecimal), keyword (String) | int | - Phải đồng bộ tiêu chí với search để hỗ trợ phân trang. | - startDate > endDate. - keyword null/blank. - maxPrice ≤ 0. | - Mock IMotorbikeDao.count. |
| IMotorbikeService.findAllByOwnerAccount | Lấy xe theo chủ sở hữu + role | accountId (int), role (String) | List<Motorbike> | - Chỉ trả xe thuộc account theo role hợp lệ (ví dụ partner). - Role không đúng → rỗng. | - role null/không hợp lệ. - accountId không tồn tại. - Không có xe nào thuộc chủ này. | - Mock IMotorbikeDao.findAllByOwnerAccount. |
| IMotorbikeService.getDetail | Lấy chi tiết xe để hiển thị | bikeId (int) | MotorbikeListItem hoặc null | - Trả null nếu không thấy xe. - Dùng bởi trang detail/booking. | - bikeId không tồn tại → null. - Dữ liệu thiếu thuộc tính hiển thị. - Lỗi DAO. | - Mock IMotorbikeDao.findDetailById. |
| IMotorbikeService.getByPartnerId | Lấy xe theo partnerId | partnerId (int) | List<Motorbike> | - Trả danh sách xe thuộc partner. | - partnerId không tồn tại. - Partner không có xe. - partnerId âm. | - Mock IMotorbikeDao.findByPartnerId. |

**Servlet**

| Function | Nhiệm vụ chính | Tham số (kiểu) | Giá trị trả | Quy tắc nghiệp vụ chính | Edge cases (≥3) | Cần mock |
|---|---|---|---|---|---|---|
| BookingServlet.doPost | Xử lý đặt xe từ trang chi tiết | HttpServletRequest, HttpServletResponse | Redirect tới `/customerorders?justCreated=...` hoặc error/redirect khác | - Bắt buộc đăng nhập (`session.account`). - Đọc `bikeId`,`start`,`end`; parse `java.sql.Date.valueOf`. - Kiểm tra xe tồn tại qua `IMotorbikeService.getDetail`. - Map `account` → `Customer` qua `ICustomerService.getProfile`. - Đặt đơn bằng `IOrderService.bookOneBike`. - Lỗi: set `session.book_error` và redirect về `/motorbikedetail?id=...`. | - Chưa đăng nhập → redirect `/login`. - Thiếu/format sai tham số ngày/id → Exception → set `book_error` và redirect detail. - Xe không tồn tại → `resp.sendError(404)`. - Không có hồ sơ Customer → redirect `/customer/profile?need=1`. - Lỗi nghiệp vụ (overlap/không bookable) → set `book_error`. | - Mock IMotorbikeService.getDetail. - Mock ICustomerService.getProfile. - Mock IOrderService.bookOneBike (thành công/ném lỗi). - Mock HttpServletRequest/Response/HttpSession. |
| MotorbikeDetailServlet.doGet | Hiển thị trang chi tiết xe | HttpServletRequest, HttpServletResponse | Forward `RequestDispatcher` tới `/motorbikes/detail.jsp` | - Lấy `bike_id` hoặc `id`; thiếu/sai → set `error`. - Gọi `IMotorbikeService.getDetail`; null → set `error`, vẫn forward. - Mọi lỗi đều forward cùng thông báo. | - Thiếu cả `bike_id` và `id`. - `id` không phải số. - Xe không tồn tại → `bike=null`, `error` hiển thị 404 UI. - Exception từ service. | - Mock IMotorbikeService.getDetail. - Mock HttpServletRequest/Response, HttpSession (nếu cần), RequestDispatcher capture forward path/attributes. |
| MyOrdersServlet.doGet | Danh sách đơn hàng của khách | HttpServletRequest, HttpServletResponse | Forward tới `/customer/my-orders.jsp` hoặc redirect | - Bắt buộc đăng nhập (`session.account`). - Lấy `Customer` từ `ICustomerService.getProfile`; thiếu → redirect `/customer/profile.jsp?need=1`. - Lấy dữ liệu từ `IOrderQueryDao.findOrdersOfCustomerWithPaymentStatus`. - Map sang `OrderVM`; set `ordersVm`, `hasPendingPayments=false`, `rows`. - Lỗi → set `session.flash` và redirect `/customerorders`. | - Chưa đăng nhập → redirect `/login.jsp`. - Profile chưa có → redirect profile. - DAO trả `null`/row không đủ cột → bỏ qua hoặc rỗng. - Casting sai kiểu từng cột. | - Mock IOrderQueryDao.findOrdersOfCustomerWithPaymentStatus. - Mock ICustomerService.getProfile. - Mock HttpServletRequest/Response/HttpSession/RequestDispatcher. |

